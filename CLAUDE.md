# Claude.md - AI Assistant Context for The Payments Nerd

This document provides context and guidelines for Claude Code when working on this codebase.

## Project Overview

The Payments Nerd is an **automated AI-powered newsletter platform** delivering curated payments industry news. It consists of two main codebases:

1. **Python AI Agent** (`/ai`) - Uses LangChain + GPT-4o to discover, analyze, and generate newsletter content from RSS feeds and web sources
2. **Next.js Web App** (`/web`) - Frontend, API routes, email delivery, and subscriber management

**Live Site:** https://thepaymentsnerd.co

### How It Works

1. **GitHub Actions** runs daily at 08:30 UTC, executing the Python AI agent
2. AI fetches RSS feeds, searches web, analyzes content with GPT-4o
3. Newsletter JSON is generated, committed to repo, and synced to Supabase
4. Vercel deployment is triggered, then emails are sent to subscribers via Resend
5. Emails skip weekends (Saturday/Sunday) to avoid spam fatigue

## Tech Stack

### Web Application (`/web`)
- **Framework:** Next.js 15 with App Router
- **UI:** React 19, Tailwind CSS v4
- **Database:** Supabase (PostgreSQL with RLS)
- **Email:** Resend + React Email components
- **Testing:** Vitest
- **Icons:** Lucide React
- **Hosting:** Vercel

### AI Newsletter Generator (`/ai`)
- **Language:** Python 3.12
- **LLM:** OpenAI GPT-4o (gpt-4o for research, gpt-4o-mini for writing/editing)
- **Orchestration:** LangChain 0.1.20
- **Web Scraping:** BeautifulSoup4 + lxml
- **Feed Parsing:** feedparser
- **Search:** DuckDuckGo Search
- **Vector DB:** Chroma (SQLite-backed, for deduplication)

## Directory Structure

```
thepaymentsnerdv2/
├── ai/                          # Python AI newsletter generator
│   ├── config.yml               # RSS feeds, search sources, industry trends
│   ├── requirements.txt         # Python dependencies
│   └── src/
│       ├── main.py              # Main agent orchestration (Researcher -> Writer -> Editor)
│       ├── config.py            # Configuration loader
│       ├── tools.py             # LangChain tools (search, scrape, RSS)
│       └── weekly_recap.py      # Weekly summary generator (optional)
│
├── web/                         # Next.js frontend application
│   ├── app/
│   │   ├── api/                 # API routes
│   │   │   ├── subscribe/       # POST - Email subscription with double opt-in
│   │   │   ├── confirm/         # GET - Email confirmation via token
│   │   │   ├── unsubscribe/     # POST - Unsubscribe handler
│   │   │   ├── send-daily/      # POST - Daily newsletter sender (cron)
│   │   │   ├── test-email/      # GET - Test email endpoint
│   │   │   └── webhooks/resend/ # POST - Resend webhook handler (bounces)
│   │   ├── page.tsx             # Homepage with newsletter preview
│   │   ├── layout.tsx           # Root layout
│   │   ├── globals.css          # CSS variables, dark mode, utility classes
│   │   ├── privacy/             # Privacy Policy (UK GDPR compliant)
│   │   ├── legal/               # Terms of Use (UK Consumer Rights Act)
│   │   └── cookies/             # Cookie Policy (UK PECR compliant)
│   ├── components/              # React components (Logo, SubscribeForm, LegalPageLayout, etc.)
│   ├── emails/                  # React Email templates
│   ├── lib/                     # Utilities (Supabase clients, tokens, email)
│   ├── scripts/                 # Helper scripts (preview email, sync to Supabase)
│   └── public/
│       └── newsletter.json      # Latest newsletter data (generated by AI)
│
├── docs/                        # Documentation (SETUP, ARCHITECTURE, EMAIL_SYSTEM, etc.)
├── db/                          # Database files (Chroma SQLite)
├── .github/workflows/           # GitHub Actions (generate_news.yml)
├── vercel.json                  # Vercel cron configuration
└── .env                         # Environment variables (not committed)
```

## Key Patterns and Conventions

### TypeScript/React Patterns

1. **Functional components with hooks** - No class components
2. **Server Components by default** - Use `"use client"` only when needed (forms, interactivity)
3. **Explicit TypeScript types** - Define interfaces for props and data structures
4. **Named exports** for components, default exports for pages

```typescript
// Good: Explicit types, functional component
interface SubscribeFormProps {
  source?: string;
}

export function SubscribeForm({ source = "homepage" }: SubscribeFormProps) {
  const [email, setEmail] = useState("");
  // ...
}
```

### API Route Patterns

1. **Use NextResponse.json()** for responses
2. **Return `{ ok: true/false, ... }` pattern** for consistency
3. **Validate input early** with simple regex/checks
4. **Log errors with console.error()** before returning error responses

```typescript
export async function POST(req: Request) {
  try {
    const { email } = await req.json();
    if (!isValidEmail(email)) {
      return NextResponse.json({ ok: false, message: "Invalid email" }, { status: 400 });
    }
    // ... logic
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    console.error("Error:", e?.message || e);
    return NextResponse.json({ ok: false, message: "Something went wrong." }, { status: 500 });
  }
}
```

### Supabase Usage

- **Client-side:** Use `supabaseClient.ts` (anon key, respects RLS)
- **Server-side:** Use `supabaseAdmin.ts` (service role key, bypasses RLS)
- The subscriber count query uses `supabaseAdmin` to bypass RLS restrictions

### Python Patterns (AI Module)

1. **Type hints** on function signatures
2. **Docstrings** for functions explaining purpose
3. **Environment variables** loaded via `python-dotenv`
4. **SQLite hack** at top of main.py for Chroma compatibility

```python
# Required at top of main.py for Chroma to work
__import__('pysqlite3')
import sys
sys.modules['sqlite3'] = sys.modules.pop('pysqlite3')
```

## Development Commands

### Web Application
```bash
cd web
npm run dev          # Start development server (http://localhost:3000)
npm run build        # Production build
npm run lint         # Run ESLint
npm test             # Run Vitest tests
npm run email:preview  # Preview email template in browser
```

### AI Newsletter Generator
```bash
cd ai
source .venv/bin/activate  # Activate virtual environment
python -m ai.src.main      # Generate newsletter (outputs to web/public/newsletter.json)
```

### Testing Email
```bash
# With dev server running:
curl "http://localhost:3000/api/test-email?secret=YOUR_CRON_SECRET&to=your@email.com"
```

## Important Gotchas

### 1. Environment Variables Location
- `.env` file must be in the **root directory** (not in `/web`)
- Next.js will find it there automatically
- Python uses `python-dotenv` to load from root

### 2. Supabase RLS (Row Level Security)
- The `subscribers` table has RLS enabled
- Use `supabaseAdmin` (service role) for server-side operations that need full access
- The anon client can only perform operations allowed by RLS policies

### 3. Newsletter JSON Location
- The AI generates `web/public/newsletter.json`
- This is also synced to Supabase `newsletters` table
- The homepage reads from Supabase, not the JSON file directly

### 4. Email Token Security
- Tokens use HMAC-SHA256 with `SUBSCRIBE_TOKEN_SECRET`
- Confirmation tokens expire in 48 hours
- Unsubscribe tokens expire in 1 year (365 * 24 hours)

### 5. ISR Caching on Homepage
- Homepage uses `export const revalidate = 900` (15-minute ISR)
- Newsletter updates won't appear instantly after generation
- This is intentional to avoid "stuck on last deployment" issues

### 6. Weekend Email Skipping
- GitHub Actions skips sending emails on Saturday/Sunday
- Newsletter is still generated and committed
- Emails resume on Monday

### 7. Chroma/SQLite Compatibility
- The Python AI module requires `pysqlite3-binary` for Chroma
- The hack at the top of `main.py` replaces sqlite3 with pysqlite3
- Don't remove this or Chroma will fail

### 8. Legal Pages (UK Compliance)
- Privacy, Terms, and Cookie policies are compliant with UK laws (GDPR, DPA 2018, Consumer Rights Act 2015, PECR 2003)
- Contact email across legal pages is `cesar@thepaymentsnerd.co`
- Legal pages use `LegalPageLayout` component with full dark mode support
- References ICO (Information Commissioner's Office) as the data protection authority

### 9. Subscriber Count Display
- Subscriber count on homepage is rounded to nearest 10 (displays as "20+", "30+", etc.)
- Count is styled with the logo gradient for brand consistency
- Uses `supabaseAdmin` to bypass RLS for accurate count

## Code Style Guidelines

### Simplicity Over Complexity

This project values **simplicity and directness**. Avoid:

1. **Over-abstraction** - Don't create utility functions for one-time use
2. **Premature optimization** - Keep code readable first
3. **Complex state management** - React useState is sufficient; no Redux/Zustand needed
4. **Over-engineered error handling** - Simple try/catch with console.error is fine

### Anti-Patterns to Avoid

```typescript
// BAD: Over-abstracted
const useSubscribeForm = () => {
  const emailState = useFormState("email");
  const formManager = useFormManager();
  // ... 50 lines of abstraction
};

// GOOD: Direct and simple
const [email, setEmail] = useState("");
const [status, setStatus] = useState<"idle" | "loading" | "success" | "error">("idle");
```

```typescript
// BAD: Unnecessary wrapper
function createApiResponse(ok: boolean, data: object) {
  return NextResponse.json({ ok, ...data });
}

// GOOD: Just use NextResponse directly
return NextResponse.json({ ok: true, data: result });
```

### Styling

- Use **Tailwind CSS classes** directly in JSX
- Use **CSS variables** for theme colors (defined in globals.css)
- Prefer **inline conditional classes** over complex className logic
- Dark mode is handled via CSS `prefers-color-scheme` media queries
- Legal pages use the `prose-legal` utility class for consistent dark mode text styling
- Use utility classes like `card-surface`, `card-surface-strong`, `glow-bg`, `bg-grid-pattern` from globals.css

### Commit Messages

Follow conventional commits format:
```
feat(subscribe): add referral tracking
fix(email): resolve iCloud delivery issues
docs: update deployment guide
```

## Bash Guidelines

### IMPORTANT: Avoid commands that cause output buffering issues

- DO NOT pipe output through `head`, `tail`, `less`, or `more` when monitoring or checking command output
- DO NOT use `| head -n X` or `| tail -n X` to truncate output - these cause buffering problems
- Instead, let commands complete fully, or use `--max-lines` flags if the command supports them
- For log monitoring, prefer reading files directly rather than piping through filters

### When checking command output:

- Run commands directly without pipes when possible
- If you need to limit output, use command-specific flags (e.g., `git log -n 10` instead of `git log | head -10`)
- Avoid chained pipes that can cause output to buffer indefinitely

## Testing

### Running Tests
```bash
cd web
npm test        # Run all tests once
npm run test    # Same as above (vitest run)
```

### Test File Location
- Tests are co-located with source files: `lib/emailTokens.test.ts`
- Use Vitest with `describe`, `it`, `expect`

### Manual Testing Checklist
1. Subscribe with test email, confirm via link
2. Check newsletter renders on homepage
3. Test unsubscribe flow
4. Verify email template renders correctly (`npm run email:preview`)

## Deployment

### Automatic Deployment Flow
1. Push to `main` triggers Vercel deployment
2. GitHub Actions runs daily at 09:00 UTC:
   - Generate newsletter with Python AI
   - Commit newsletter.json to repo
   - Sync to Supabase
   - Trigger Vercel deploy hook
   - Send emails to subscribers (weekdays only)

### Manual Newsletter Generation
```bash
# Local generation
cd ai && source .venv/bin/activate && python -m ai.src.main

# Then commit and push
cd ../web
npm run publish  # Commits and pushes newsletter.json
```

### Vercel Cron
- Configured in `vercel.json`
- Runs `/api/send-daily` at 07:00 UTC daily
- Acts as a fallback if GitHub Actions email step fails

## Database Schema

### subscribers table
```sql
id UUID PRIMARY KEY
email TEXT UNIQUE NOT NULL
status TEXT DEFAULT 'pending'  -- 'pending', 'active', 'unsubscribed'
confirmed_at TIMESTAMP
referral_code TEXT
referred_by TEXT
consent_ip TEXT
consent_user_agent TEXT
```

### newsletters table
```sql
id UUID PRIMARY KEY
publication_date DATE UNIQUE NOT NULL
content JSONB NOT NULL  -- The full newsletter JSON
sent_at TIMESTAMP
```

## API Endpoints Reference

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/subscribe` | POST | Public | Subscribe email, sends confirmation |
| `/api/confirm` | GET | Token | Confirm subscription via token |
| `/api/unsubscribe` | POST | Token | Unsubscribe from newsletter |
| `/api/send-daily` | GET | Bearer | Send daily newsletter (cron) |
| `/api/test-email` | GET | Secret | Send test email |
| `/api/webhooks/resend` | POST | Signature | Handle Resend events |

## Quick Reference: Common Tasks

### Add a new RSS feed source
Edit `ai/config.yml`:
```yaml
newsletters:
  - url: "https://example.com/feed.rss"
    topic: "Topic Name"
```

### Modify email template
Edit `web/emails/DailyNewsletter.tsx`, then preview with:
```bash
npm run email:preview
```

### Add a new API route
Create `web/app/api/[route-name]/route.ts` with GET/POST handlers.

### Update industry trends for AI
Edit `ai/config.yml` under `current_trends` section. Each trend has:
- `name`: Trend title
- `weight`: Importance score 1-10 (higher = more focus)
- `description`: Context for the AI
- `signals`: Keywords to detect in news
- `companies_to_watch`: Relevant companies
- `watch_for`: Specific developments to monitor

### Modify legal pages
Edit files in `web/app/` directory:
- `privacy/page.tsx` - Privacy Policy
- `legal/page.tsx` - Terms of Use
- `cookies/page.tsx` - Cookie Policy

All legal pages use the `LegalPageLayout` component and `prose-legal` CSS class for consistent styling.

### Check subscriber count
```sql
SELECT COUNT(*) FROM subscribers WHERE status = 'active';
```

## Troubleshooting

### Newsletter not generating
1. Check OpenAI API key has credits
2. Verify RSS feeds are accessible
3. Run locally to see errors: `python -m ai.src.main`

### Emails going to spam
1. Verify DNS records (SPF, DKIM, DMARC)
2. Check Resend domain verification status
3. See `docs/EMAIL_SYSTEM.md` for details

### Homepage showing old newsletter
1. ISR cache is 15 minutes - wait or redeploy
2. Check Supabase `newsletters` table has latest entry
3. Verify `syncToSupabase.js` ran successfully

### Supabase connection errors
1. Check project isn't paused (free tier auto-pauses)
2. Verify API keys in `.env` are correct
3. Ensure RLS policies allow the operation

## External Documentation

- [Next.js App Router](https://nextjs.org/docs/app)
- [React Email](https://react.email/docs)
- [Resend API](https://resend.com/docs)
- [Supabase Docs](https://supabase.com/docs)
- [LangChain Python](https://python.langchain.com/)
- [Tailwind CSS v4](https://tailwindcss.com/docs)
